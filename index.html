<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarStereo AudioPlayer v2.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --main-bg: #050505; --main-text: #10b981; --panel-bg: rgba(6, 78, 59, 0.1); --border: #064e3b; }
        .day-mode { --main-bg: #f3f4f6; --main-text: #065f46; --panel-bg: #ffffff; --border: #d1d5db; }
        body { background-color: var(--main-bg); color: var(--main-text); font-family: 'Courier New', Courier, monospace; transition: all 0.3s ease; }
        .lcd-glow { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .preset-btn { transition: all 0.2s; border: 2px solid var(--border); background: var(--panel-bg); position: relative; overflow: hidden; }
        .preset-btn:active { background: #10b981; color: #000; transform: scale(0.95); }
        .preset-label { font-size: 0.65rem; position: absolute; bottom: 4px; left: 0; right: 0; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px; font-weight: bold; }
        input[type=range] { accent-color: #10b981; height: 16px; width: 100%; cursor: pointer; }
        .safe-btn { padding: 12px 16px; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: opacity 0.2s; }
        .safe-btn:active { opacity: 0.6; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <header class="p-4 flex justify-between items-center border-b border-emerald-900/30">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold tracking-tighter lcd-glow">CAR UNIT v2.8</h1>
            <div id="v-tag" class="text-[10px] opacity-50">FILENAME PRESETS ACTIVE</div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleDayMode()" class="safe-btn border border-emerald-900 text-[10px]">‚òÄÔ∏è/üåô</button>
            <button onclick="toggleView('library')" class="safe-btn bg-emerald-900 text-black text-[10px]">Library</button>
            <button onclick="toggleView('logs')" class="safe-btn border border-emerald-900 text-[10px]">Logs</button>
        </div>
    </header>

    <main id="view-player" class="flex-1 flex flex-col p-4 gap-4">
        <div class="flex-1 rounded-3xl border-2 border-emerald-900/50 bg-emerald-950/10 p-6 flex flex-col justify-center relative overflow-hidden">
            <div class="absolute top-4 left-6 text-[10px] uppercase opacity-40 tracking-[0.2em]" id="mode-indicator">SYSTEM READY</div>
            <div class="text-3xl font-bold truncate mb-2 lcd-glow" id="display-title">READY</div>
            <div class="text-lg opacity-60 truncate" id="display-subtitle">SELECT SOURCE</div>
            <div id="playback-info" class="mt-6">
                <input type="range" id="seek-bar" value="0">
                <div class="flex justify-between text-xs mt-2 font-mono font-bold">
                    <span id="current-time">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4 px-2">
            <span class="text-xs font-bold">VOL</span>
            <input type="range" id="vol-control" min="0" max="1" step="0.1" value="1">
        </div>

        <div class="grid grid-cols-3 gap-3">
            <button onmousedown="handlePresetStart(1)" onmouseup="handlePresetEnd(1)" ontouchstart="handlePresetStart(1)" ontouchend="handlePresetEnd(1)" class="preset-btn h-20 rounded-2xl text-3xl font-bold" id="btn-1">1<span class="preset-label" id="label-1"></span></button>
            <button onmousedown="handlePresetStart(2)" onmouseup="handlePresetEnd(2)" ontouchstart="handlePresetStart(2)" ontouchend="handlePresetEnd(2)" class="preset-btn h-20 rounded-2xl text-3xl font-bold" id="btn-2">2<span class="preset-label" id="label-2"></span></button>
            <button onmousedown="handlePresetStart(3)" onmouseup="handlePresetEnd(3)" ontouchstart="handlePresetStart(3)" ontouchend="handlePresetEnd(3)" class="preset-btn h-20 rounded-2xl text-3xl font-bold" id="btn-3">3<span class="preset-label" id="label-3"></span></button>
            <button onmousedown="handlePresetStart(4)" onmouseup="handlePresetEnd(4)" ontouchstart="handlePresetStart(4)" ontouchend="handlePresetEnd(4)" class="preset-btn h-20 rounded-2xl text-3xl font-bold" id="btn-4">4<span class="preset-label" id="label-4"></span></button>
            <button onmousedown="handlePresetStart(5)" onmouseup="handlePresetEnd(5)" ontouchstart="handlePresetStart(5)" ontouchend="handlePresetEnd(5)" class="preset-btn h-20 rounded-2xl text-3xl font-bold" id="btn-5">5<span class="preset-label" id="label-5"></span></button>
            <button onmousedown="handlePresetStart(6)" onmouseup="handlePresetEnd(6)" ontouchstart="handlePresetStart(6)" ontouchend="handlePresetEnd(6)" class="preset-btn h-20 rounded-2xl text-3xl font-bold" id="btn-6">6<span class="preset-label" id="label-6"></span></button>
        </div>

        <div class="h-24 flex gap-4 items-center">
            <button onclick="prevTrack()" class="flex-1 h-full bg-zinc-800 rounded-2xl text-4xl border border-zinc-700 active:bg-emerald-600">‚èÆ</button>
            <button onclick="togglePlay()" id="play-btn" class="w-1/3 h-full bg-emerald-600 text-black rounded-2xl text-5xl shadow-lg active:bg-emerald-400">‚ñ∂</button>
            <button onclick="nextTrack()" class="flex-1 h-full bg-zinc-800 rounded-2xl text-4xl border border-zinc-700 active:bg-emerald-600">‚è≠</button>
        </div>
    </main>

    <div id="overlay-library" class="fixed inset-0 bg-black z-50 p-6 hidden flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">LIBRARY</h2>
            <div class="flex gap-2">
                <button id="mgr-toggle" onclick="toggleManager()" class="safe-btn border border-blue-900 text-[10px]">Manage Radio</button>
                <button onclick="toggleView('player')" class="safe-btn bg-red-900 text-white">CLOSE</button>
            </div>
        </div>
        <input type="text" id="lib-search" oninput="renderLibrary()" placeholder="SEARCH BOOKS/STATIONS..." class="w-full bg-zinc-900 border-2 border-emerald-900 p-4 rounded-xl mb-4 text-emerald-400">
        <div id="library-content" class="flex-1 overflow-y-auto space-y-4 pr-2"></div>
        <div class="mt-4 p-4 border border-emerald-900 rounded-xl bg-zinc-900/50">
            <button onclick="toggleRadioForm()" class="w-full text-xs opacity-50 mb-2">ADD RADIO STATION (+)</button>
            <div id="radio-form" class="hidden flex flex-col gap-2">
                <input type="text" id="radio-name" placeholder="Name" class="bg-black border border-emerald-900 p-2 rounded">
                <input type="text" id="radio-url" placeholder="URL" class="bg-black border border-emerald-900 p-2 rounded">
                <button onclick="addRadioStation()" class="bg-emerald-700 text-black font-bold p-3 rounded-xl">SAVE STATION</button>
            </div>
        </div>
    </div>

    <div id="overlay-logs" class="fixed inset-0 bg-black z-50 p-6 hidden flex flex-col font-mono text-xs">
        <div class="flex justify-between mb-4"><h2 class="text-xl">SYSTEM LOGS</h2><button onclick="toggleView('player')">‚úï</button></div>
        <div id="log-content" class="flex-1 bg-zinc-900 p-4 rounded overflow-y-auto border border-emerald-900"></div>
    </div>
    <audio id="audio-player" class="hidden"></audio>

<script>
    const BOOKMARKS_ENDPOINT = './api/bookmarks';
    const USER_ID = new URLSearchParams(window.location.search).get('user') || 'default_stereo';
    let state = { presets: {}, radioStations: [], books: {}, currentSource: null, playbackPositions: {}, longPressTimer: null, isHolding: false, isManagerMode: false };
    const audio = document.getElementById('audio-player');

    function appendLog(msg) {
        const log = document.getElementById('log-content');
        if (!log) return;
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    function toggleDayMode() { document.body.classList.toggle('day-mode'); }
    function toggleView(v) {
        document.getElementById('overlay-library').classList.toggle('hidden', v !== 'library');
        document.getElementById('overlay-logs').classList.toggle('hidden', v !== 'logs');
    }
    function toggleRadioForm() { document.getElementById('radio-form').classList.toggle('hidden'); }
    function toggleManager() { 
        state.isManagerMode = !state.isManagerMode; 
        document.getElementById('mgr-toggle').textContent = state.isManagerMode ? "Done Managing" : "Manage Radio";
        renderLibrary(); 
    }

    audio.addEventListener('play', () => { document.getElementById('play-btn').textContent = '||'; });
    audio.addEventListener('pause', () => { document.getElementById('play-btn').textContent = '‚ñ∂'; });

    async function sync(method = 'GET', body = null) {
        try {
            const options = { method };
            if (body) { options.headers = { 'Content-Type': 'application/json' }; options.body = JSON.stringify(body); }
            const res = await fetch(`${BOOKMARKS_ENDPOINT}?user=${encodeURIComponent(USER_ID)}`, options);
            return res.ok ? await res.json() : null;
        } catch (e) { appendLog("Sync Error: " + e.message); return null; }
    }

    async function scanServer() {
        appendLog("Scanning v2.8: Checking /books...");
        try {
            const res = await fetch('./books/');
            if (!res.ok) return;
            const text = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const links = Array.from(doc.querySelectorAll('a')).map(a => a.getAttribute('href')).filter(h => h && !h.startsWith('?') && !h.startsWith('/'));
            
            state.books = {}; // Clear existing
            for (const link of links) {
                if (link.endsWith('/')) {
                    const bookName = decodeURIComponent(link.replace(/\/$/, ''));
                    const trackRes = await fetch(`./books/${link}`);
                    const tracks = Array.from(parser.parseFromString(await trackRes.text(), 'text/html').querySelectorAll('a'))
                        .map(a => a.getAttribute('href')).filter(h => h.toLowerCase().endsWith('.mp3'))
                        .map(h => ({ name: decodeURIComponent(h), url: `./books/${link}${h}` }));
                    if (tracks.length > 0) state.books[bookName] = tracks;
                } else if (link.toLowerCase().endsWith('.mp3')) {
                    // Treat root files as individual "Books" named after the file
                    const fileName = decodeURIComponent(link);
                    state.books[fileName] = [{ name: fileName, url: `./books/${link}` }];
                }
            }
            appendLog(`Scan complete. Found ${Object.keys(state.books).length} items.`);
            renderLibrary();
        } catch (e) { appendLog("Scan failed: " + e.message); }
    }

    function handlePresetStart(id) {
        state.isHolding = false;
        state.longPressTimer = setTimeout(() => {
            if (state.currentSource) {
                state.presets[id] = state.currentSource;
                saveAllData();
                document.getElementById(`btn-${id}`).classList.add('bg-emerald-400', 'text-black');
                setTimeout(() => document.getElementById(`btn-${id}`).classList.remove('bg-emerald-400', 'text-black'), 500);
                updatePresetLabels();
                state.isHolding = true;
            }
        }, 1000);
    }

    function handlePresetEnd(id) {
        clearTimeout(state.longPressTimer);
        if (!state.isHolding && state.presets[id]) {
            const p = state.presets[id];
            p.type === 'radio' ? playRadio(p.data) : playBook(p.data.bookName, p.data.trackIdx);
        }
    }

    function quickAssign(id, type, data) {
        state.presets[id] = { type, data };
        saveAllData();
        updatePresetLabels();
        appendLog(`Quick Assign P${id}`);
    }

    function updatePresetLabels() {
        for (let i = 1; i <= 6; i++) {
            const label = document.getElementById(`label-${i}`);
            const p = state.presets[i];
            if (p) {
                // Prioritize specific name/filename over category
                label.textContent = p.type === 'radio' ? p.data.name : (p.data.name || p.data.bookName);
            } else {
                label.textContent = "";
            }
        }
    }

    function renderLibrary() {
        const query = document.getElementById('lib-search').value.toLowerCase();
        const container = document.getElementById('library-content');
        container.innerHTML = '';
        state.radioStations.filter(s => s.name.toLowerCase().includes(query)).forEach((s, idx) => {
            container.appendChild(createLibEntry(s.name, () => playRadio(s), 'radio', s, idx));
        });
        Object.keys(state.books).forEach(bookName => {
            state.books[bookName].filter(t => t.name.toLowerCase().includes(query) || bookName.toLowerCase().includes(query)).forEach((t, i) => {
                const bookData = { bookName, trackIdx: i, url: t.url, name: t.name };
                // Display only the filename for items without a category folder
                const displayLabel = (bookName === t.name) ? t.name : `${bookName} - ${t.name}`;
                container.appendChild(createLibEntry(displayLabel, () => playBook(bookName, i), 'book', bookData));
            });
        });
    }

    function createLibEntry(label, tuneFn, type, data, idx = null) {
        const div = document.createElement('div');
        div.className = "flex flex-col bg-zinc-900 border-2 border-zinc-800 p-4 rounded-2xl gap-3";
        let managementTools = (state.isManagerMode && type === 'radio' && idx !== null) ? `
            <div class="flex gap-2 w-full mt-2">
                <button onclick="this.edit(${idx})" class="bg-blue-900 safe-btn flex-1 text-[10px]">EDIT NAME/URL</button>
                <button onclick="this.del(${idx})" class="bg-red-900 safe-btn flex-1 text-[10px]">DELETE</button>
            </div>` : '';
        div.innerHTML = `
            <div class="font-bold truncate text-lg">${label}</div>
            <div class="flex flex-wrap gap-2">
                <button class="safe-btn bg-emerald-600 text-black flex-1" onclick="this.tune()">TUNE</button>
                <div class="flex gap-1">
                    ${[1,2,3,4,5,6].map(p => `<button onclick="this.assign(${p})" class="bg-zinc-700 px-3 py-2 rounded-lg text-[10px] font-bold">P${p}</button>`).join('')}
                </div>
            </div>${managementTools}`;
        div.querySelector('button.bg-emerald-600').tune = tuneFn;
        div.querySelectorAll('button[onclick^="this.assign"]').forEach(b => {
            const p = b.getAttribute('onclick').match(/\d+/)[0];
            b.onclick = () => quickAssign(p, type, data);
        });
        if (state.isManagerMode && type === 'radio') {
            div.querySelector('button.bg-blue-900').edit = editRadio;
            div.querySelector('button.bg-red-900').del = deleteRadio;
        }
        return div;
    }

    function editRadio(idx) {
        const s = state.radioStations[idx];
        const n = prompt("Edit Name:", s.name);
        const u = prompt("Edit URL:", s.url);
        if (n && u) { state.radioStations[idx] = {name:n, url:u}; saveAllData(); renderLibrary(); }
    }
    function deleteRadio(idx) {
        if(confirm("Delete Station?")) { state.radioStations.splice(idx, 1); saveAllData(); renderLibrary(); }
    }
    function playRadio(station) {
        state.currentSource = { type: 'radio', data: station };
        audio.src = station.url;
        document.getElementById('display-title').textContent = station.name.toUpperCase();
        document.getElementById('display-subtitle').textContent = "RADIO";
        document.getElementById('playback-info').style.opacity = "0.2";
        audio.play(); toggleView('player');
    }
    function playBook(bookName, trackIdx) {
        const track = state.books[bookName][trackIdx];
        state.currentSource = { type: 'book', data: { bookName, trackIdx, url: track.url, name: track.name } };
        audio.src = track.url;
        document.getElementById('display-title').textContent = track.name.toUpperCase();
        document.getElementById('display-subtitle').textContent = (bookName === track.name) ? "FILE" : bookName.toUpperCase();
        document.getElementById('playback-info').style.opacity = "1";
        const trackKey = `server:${track.url}`;
        if (state.playbackPositions[trackKey]) audio.currentTime = state.playbackPositions[trackKey];
        audio.play(); toggleView('player');
    }
    function addRadioStation() {
        const n = document.getElementById('radio-name').value;
        const u = document.getElementById('radio-url').value;
        if(n && u) { state.radioStations.push({name:n, url:u}); saveAllData(); renderLibrary(); toggleRadioForm(); }
    }
    function saveAllData() { sync('POST', state); }
    audio.ontimeupdate = () => {
        const bar = document.getElementById('seek-bar');
        bar.value = audio.currentTime; bar.max = audio.duration || 0;
        document.getElementById('current-time').textContent = formatTime(audio.currentTime);
        document.getElementById('duration').textContent = formatTime(audio.duration);
        if (state.currentSource?.type === 'book' && Math.floor(audio.currentTime) % 15 === 0) {
            state.playbackPositions[`server:${state.currentSource.data.url}`] = audio.currentTime;
            saveAllData();
        }
    };
    document.getElementById('vol-control').oninput = (e) => audio.volume = e.target.value;
    document.getElementById('seek-bar').oninput = (e) => audio.currentTime = e.target.value;
    function formatTime(s) { if(isNaN(s)) return "00:00"; const m=Math.floor(s/60); const sec=Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }
    function togglePlay() { audio.paused ? audio.play() : audio.pause(); }
    async function init() {
        appendLog("Car Stereo Init v2.8");
        const data = await sync('GET');
        if (data) { Object.assign(state, data); }
        await scanServer();
        updatePresetLabels();
    }
    init();
</script>
</body>
</html>
