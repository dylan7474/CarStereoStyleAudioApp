<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarStereo AudioPlayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #10b981; font-family: 'Courier New', Courier, monospace; }
        .lcd-glow { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .preset-btn { transition: all 0.2s; border: 2px solid #064e3b; background: #0a0a0a; }
        .preset-btn:active { background: #10b981; color: #000; transform: scale(0.95); }
        input[type=range] { accent-color: #10b981; height: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="p-4 flex justify-between items-center border-b border-emerald-900/30">
        <h1 class="text-xl font-bold tracking-tighter lcd-glow">CAR UNIT v2.0</h1>
        <div class="flex gap-4 text-xs">
            <button onclick="toggleView('library')" class="uppercase border border-emerald-900 px-3 py-1 rounded">Library</button>
            <button onclick="toggleView('settings')" class="uppercase border border-emerald-900 px-3 py-1 rounded">Setup</button>
        </div>
    </header>

    <main id="view-player" class="flex-1 flex flex-col p-4 gap-4">
        <div class="flex-1 rounded-3xl border-2 border-emerald-900/50 bg-emerald-950/10 p-6 flex flex-col justify-center relative overflow-hidden">
            <div class="absolute top-4 left-6 text-[10px] uppercase opacity-40 tracking-[0.2em]" id="mode-indicator">SYSTEM READY</div>
            <div class="text-3xl font-bold truncate mb-2 lcd-glow" id="display-title">CAR STEREO</div>
            <div class="text-lg opacity-60 truncate" id="display-subtitle">SELECT SOURCE</div>
            
            <div id="playback-info" class="mt-8">
                <input type="range" id="seek-bar" class="w-full bg-emerald-900 rounded-lg appearance-none cursor-pointer" value="0">
                <div class="flex justify-between text-xs mt-2 font-mono">
                    <span id="current-time">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <button onmousedown="handlePresetStart(1)" onmouseup="handlePresetEnd(1)" class="preset-btn h-16 rounded-xl text-2xl font-bold" id="btn-1">1</button>
            <button onmousedown="handlePresetStart(2)" onmouseup="handlePresetEnd(2)" class="preset-btn h-16 rounded-xl text-2xl font-bold" id="btn-2">2</button>
            <button onmousedown="handlePresetStart(3)" onmouseup="handlePresetEnd(3)" class="preset-btn h-16 rounded-xl text-2xl font-bold" id="btn-3">3</button>
            <button onmousedown="handlePresetStart(4)" onmouseup="handlePresetEnd(4)" class="preset-btn h-16 rounded-xl text-2xl font-bold" id="btn-4">4</button>
            <button onmousedown="handlePresetStart(5)" onmouseup="handlePresetEnd(5)" class="preset-btn h-16 rounded-xl text-2xl font-bold" id="btn-5">5</button>
            <button onmousedown="handlePresetStart(6)" onmouseup="handlePresetEnd(6)" class="preset-btn h-16 rounded-xl text-2xl font-bold" id="btn-6">6</button>
        </div>

        <div class="h-28 flex gap-4 items-center">
            <button onclick="prevTrack()" class="flex-1 h-full bg-zinc-900 rounded-2xl text-4xl border border-zinc-800 active:bg-zinc-800">⏮</button>
            <button onclick="togglePlay()" id="play-btn" class="w-1/3 h-full bg-emerald-600 text-black rounded-2xl text-5xl shadow-lg active:bg-emerald-400">▶</button>
            <button onclick="nextTrack()" class="flex-1 h-full bg-zinc-900 rounded-2xl text-4xl border border-zinc-800 active:bg-zinc-800">⏭</button>
        </div>
    </main>

    <div id="overlay-library" class="fixed inset-0 bg-black z-50 p-6 hidden overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">SOURCES</h2>
            <button onclick="toggleView('player')" class="text-3xl">✕</button>
        </div>
        
        <div class="mb-6 p-4 border border-emerald-900 rounded-xl bg-zinc-900/50">
            <h3 class="text-sm uppercase mb-3 opacity-50">Add Radio Stream</h3>
            <div class="flex flex-col gap-2">
                <input type="text" id="radio-name" placeholder="Station Name" class="bg-black border border-emerald-900 p-2 rounded text-emerald-400">
                <input type="text" id="radio-url" placeholder="URL (mp3/aac)" class="bg-black border border-emerald-900 p-2 rounded text-emerald-400">
                <button onclick="addRadioStation()" class="bg-emerald-700 text-black font-bold p-2 rounded">ADD STATION</button>
            </div>
        </div>

        <div id="library-content" class="space-y-6"></div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

<script>
    const BOOKMARKS_ENDPOINT = './api/bookmarks';
    const USER_ID = new URLSearchParams(window.location.search).get('user') || 'default_stereo';

    let state = {
        presets: {},
        radioStations: [],
        books: {},
        currentSource: null,
        playbackPositions: {},
        longPressTimer: null,
        isHolding: false
    };

    const audio = document.getElementById('audio-player');
    const displayTitle = document.getElementById('display-title');
    const displaySubtitle = document.getElementById('display-subtitle');

    // --- SERVER SYNC ---
    async function sync(method = 'GET', body = null) {
        try {
            const options = { method };
            if (body) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(body);
            }
            const res = await fetch(`${BOOKMARKS_ENDPOINT}?user=${encodeURIComponent(USER_ID)}`, options);
            return res.ok ? await res.json() : null;
        } catch (e) { console.error("Sync Error:", e); return null; }
    }

    async function loadData() {
        const data = await sync('GET');
        if (data) {
            state.presets = data.presets || {};
            state.radioStations = data.radioStations || [];
            state.playbackPositions = data.playbackPositions || {};
            renderLibrary();
        }
    }

    async function saveData() {
        await sync('POST', {
            presets: state.presets,
            radioStations: state.radioStations,
            playbackPositions: state.playbackPositions
        });
    }

    // --- PLAYBACK ---
    function playRadio(station) {
        state.currentSource = { type: 'radio', data: station };
        audio.src = station.url;
        displayTitle.textContent = station.name.toUpperCase();
        displaySubtitle.textContent = "LIVE STREAM";
        document.getElementById('playback-info').style.opacity = "0.2";
        audio.play();
        toggleView('player');
    }

    function playBook(bookName, trackIdx) {
        const track = state.books[bookName][trackIdx];
        const trackKey = `server:${track.url}`;
        state.currentSource = { type: 'book', data: { bookName, trackIdx, url: track.url, name: track.name } };
        
        audio.src = track.url;
        displayTitle.textContent = track.name.toUpperCase();
        displaySubtitle.textContent = bookName.toUpperCase();
        document.getElementById('playback-info').style.opacity = "1";
        
        // Restore position
        const saved = state.playbackPositions[trackKey];
        if (saved) audio.currentTime = saved;
        
        audio.play();
        toggleView('player');
    }

    function togglePlay() {
        audio.paused ? audio.play() : audio.pause();
        document.getElementById('play-btn').textContent = audio.paused ? '▶' : '||';
    }

    // --- PRESETS ---
    function handlePresetStart(id) {
        state.isHolding = false;
        state.longPressTimer = setTimeout(() => {
            if (state.currentSource) {
                state.presets[id] = state.currentSource;
                saveData();
                const btn = document.getElementById(`btn-${id}`);
                btn.classList.add('bg-emerald-400', 'text-black');
                setTimeout(() => btn.classList.remove('bg-emerald-400', 'text-black'), 500);
                state.isHolding = true;
            }
        }, 1000);
    }

    function handlePresetEnd(id) {
        clearTimeout(state.longPressTimer);
        if (!state.isHolding && state.presets[id]) {
            const p = state.presets[id];
            p.type === 'radio' ? playRadio(p.data) : playBook(p.data.bookName, p.data.trackIdx);
        }
    }

    // --- LIBRARY & SCAN ---
    function addRadioStation() {
        const name = document.getElementById('radio-name').value;
        const url = document.getElementById('radio-url').value;
        if (name && url) {
            state.radioStations.push({ name, url });
            saveData();
            renderLibrary();
            document.getElementById('radio-name').value = '';
            document.getElementById('radio-url').value = '';
        }
    }

    async function scanServer() {
        try {
            const res = await fetch('./books/');
            if (!res.ok) return;
            const text = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const links = Array.from(doc.querySelectorAll('a'))
                .map(a => a.getAttribute('href'))
                .filter(h => h && h !== '../' && h.endsWith('/'));

            for (const link of links) {
                const bookName = decodeURIComponent(link.replace(/\/$/, ''));
                const trackRes = await fetch(`./books/${link}`);
                const trackText = await trackRes.text();
                const trackDoc = parser.parseFromString(trackText, 'text/html');
                const tracks = Array.from(trackDoc.querySelectorAll('a'))
                    .map(a => a.getAttribute('href'))
                    .filter(h => h.toLowerCase().endsWith('.mp3'))
                    .map(h => ({ name: decodeURIComponent(h), url: `./books/${link}${h}` }));
                
                if (tracks.length > 0) state.books[bookName] = tracks;
            }
            renderLibrary();
        } catch (e) { console.error("Scan failed", e); }
    }

    function renderLibrary() {
        const container = document.getElementById('library-content');
        container.innerHTML = '';

        // Radio Section
        const rHeader = document.createElement('h3');
        rHeader.className = "text-emerald-500 font-bold border-b border-emerald-900 pb-2";
        rHeader.textContent = "RADIO STATIONS";
        container.appendChild(rHeader);
        state.radioStations.forEach(s => {
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-zinc-900 p-3 rounded-lg border border-zinc-800";
            div.innerHTML = `<span>${s.name}</span> <button onclick='playRadio(${JSON.stringify(s)})' class="bg-emerald-900 px-3 py-1 rounded text-xs">TUNE</button>`;
            container.appendChild(div);
        });

        // Books Section
        const bHeader = document.createElement('h3');
        bHeader.className = "text-emerald-500 font-bold border-b border-emerald-900 pb-2 mt-4";
        bHeader.textContent = "AUDIOBOOKS";
        container.appendChild(bHeader);
        Object.keys(state.books).forEach(bookName => {
            const div = document.createElement('div');
            div.className = "p-3 bg-zinc-900 rounded-lg border border-zinc-800 mb-2";
            div.innerHTML = `<div class="font-bold mb-2">${bookName}</div>`;
            state.books[bookName].forEach((t, i) => {
                const btn = document.createElement('button');
                btn.className = "block w-full text-left text-xs py-1 opacity-70 hover:opacity-100";
                btn.textContent = t.name;
                btn.onclick = () => playBook(bookName, i);
                div.appendChild(btn);
            });
            container.appendChild(div);
        });
    }

    // --- UI HELPERS ---
    function toggleView(view) {
        document.getElementById('overlay-library').classList.toggle('hidden', view !== 'library');
    }

    function formatTime(s) {
        if (isNaN(s)) return "00:00";
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    audio.ontimeupdate = () => {
        const bar = document.getElementById('seek-bar');
        bar.value = audio.currentTime;
        bar.max = audio.duration || 0;
        document.getElementById('current-time').textContent = formatTime(audio.currentTime);
        document.getElementById('duration').textContent = formatTime(audio.duration);
        
        // Save audiobook progress every 10 seconds
        if (state.currentSource?.type === 'book' && Math.floor(audio.currentTime) % 10 === 0) {
            state.playbackPositions[`server:${state.currentSource.data.url}`] = audio.currentTime;
            saveData();
        }
    };

    document.getElementById('seek-bar').oninput = (e) => audio.currentTime = e.target.value;

    async function init() {
        await loadData();
        await scanServer();
    }
    init();
</script>
</body>
</html>
