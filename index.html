<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarStereo Infotainment v4.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Nixie+One&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/dseg7-classic" rel="stylesheet">
    <style>
        :root { 
            --bg: #0a0c10; --bg-spot: #1e293b; --text: #e2e8f0; --accent: #10b981; --time-color: #f59e0b;
            --panel: rgba(30, 41, 59, 0.5); --glass: rgba(255, 255, 255, 0.03);
        }
        body[data-theme="classic"] {
            --bg: #0a0c10; --bg-spot: #1e293b; --text: #e2e8f0; --accent: #10b981; --time-color: #f59e0b;
            --panel: rgba(30, 41, 59, 0.5); --glass: rgba(255, 255, 255, 0.03);
        }
        body[data-theme="sunset"] {
            --bg: #12090c; --bg-spot: #3b0a14; --text: #fde7d5; --accent: #fb923c; --time-color: #facc15;
            --panel: rgba(84, 24, 36, 0.55); --glass: rgba(255, 255, 255, 0.05);
        }
        body[data-theme="neon"] {
            --bg: #050711; --bg-spot: #0f172a; --text: #e0f2fe; --accent: #38bdf8; --time-color: #a78bfa;
            --panel: rgba(15, 23, 42, 0.65); --glass: rgba(56, 189, 248, 0.08);
        }
        body[data-theme="glacier"] {
            --bg: #050e12; --bg-spot: #0f2a35; --text: #e0f7ff; --accent: #22d3ee; --time-color: #38bdf8;
            --panel: rgba(8, 40, 52, 0.6); --glass: rgba(34, 211, 238, 0.08);
        }
        .day-mode { 
            --bg: #f8fafc; --bg-spot: #e2e8f0; --text: #1e293b; --accent: #059669; --time-color: #d97706;
            --panel: rgba(226, 232, 240, 0.8); --glass: rgba(0, 0, 0, 0.05);
        }
        body { 
            background: radial-gradient(circle at top right, var(--bg-spot), var(--bg)); 
            color: var(--text); font-family: 'Inter', sans-serif; transition: all 0.5s ease; 
        }
        .glass-card { background: var(--panel); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; }
        .lcd-display {
            background-image:
                repeating-linear-gradient(90deg, rgba(16, 185, 129, 0.08) 0, rgba(16, 185, 129, 0.08) 1px, rgba(0, 0, 0, 0) 1px, rgba(0, 0, 0, 0) 4px),
                linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(0,0,0,0) 100%);
            background-blend-mode: screen;
        }
        .preset-btn { background: var(--glass); border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; border-radius: 1.25rem; }
        .preset-active { background: var(--accent) !important; color: white !important; box-shadow: 0 0 15px var(--accent); border-color: transparent; }
        .lib-p-active { background: var(--accent) !important; color: white !important; box-shadow: 0 0 15px var(--accent); border-color: transparent; }
        .preset-label { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; opacity: 0.7; }
        .time-display {
            font-family: 'DSEG7 Classic', 'Inter', sans-serif;
            letter-spacing: 0.08em;
            position: relative;
            display: inline-block;
            line-height: 1;
            color: var(--time-color);
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 4px rgba(245, 158, 11, 0.35);
        }
        .time-display-glow {
            text-shadow: 0 0 3px rgba(245, 158, 11, 0.5), 0 0 10px rgba(245, 158, 11, 0.35);
        }
        
        
        input[type=range].seek-bar { 
            width: 100%; height: 12px; border-radius: 0; background: rgba(255,255,255,0.1); 
            appearance: none; outline: none; margin: 0; cursor: pointer;
        }
        input[type=range].seek-bar::-webkit-slider-thumb {
            appearance: none; width: 24px; height: 24px; 
            background: var(--accent); border-radius: 50%; border: 2px solid white;
            box-shadow: 0 0 15px var(--accent);
        }
        input[type=range].vol-vertical {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 12px;
            height: 100%;
            margin: 0;
        }
        #progress-block { grid-area: progress; }
        #volume-block { grid-area: volume; }
        #sleep-block { grid-area: sleep; }
        #preset-block { grid-area: presets; }
        #transport-block { grid-area: transport; }
        body[data-layout="alt"] #control-stack {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            grid-template-areas:
                "progress progress"
                "sleep presets"
                "transport presets"
                "volume volume";
            gap: 1.25rem;
        }
        body[data-layout="alt"] #preset-block .preset-btn { height: 4.5rem; }
        body[data-layout="alt"] #sleep-block button { padding-top: 0.6rem; padding-bottom: 0.6rem; font-size: 0.65rem; }
        body[data-layout="alt"] #transport-block { height: 5rem; }
        body[data-layout="alt"] #transport-block button { font-size: 1.75rem; }
        @media (max-width: 640px) {
            body[data-layout="alt"] #control-stack {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "progress"
                    "sleep"
                    "presets"
                    "transport"
                    "volume";
                gap: 0.75rem;
            }
            body[data-layout="alt"] #preset-block .preset-btn { height: 3.25rem; }
            body[data-layout="alt"] #transport-block { height: 4.25rem; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden p-4 sm:p-6" data-theme="classic" data-layout="classic">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight">INFOTAINMENT <span class="text-emerald-500 font-light">4.3</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="toggleOptions()" id="options-toggle" class="p-3 rounded-full bg-white/5 border border-white/10">⚙️</button>
            <button onclick="toggleDayMode()" class="p-3 rounded-full bg-white/5 border border-white/10">☀️</button>
            <button onclick="toggleView('library')" class="px-6 py-2 rounded-2xl font-bold bg-emerald-500 text-black active:scale-95 transition-transform">LIBRARY</button>
        </div>
    </header>

    <div id="options-panel" class="fixed top-20 right-6 z-40 hidden glass-card bg-black/60 p-4 w-64 flex flex-col gap-4 shadow-2xl">
        <div class="flex items-center justify-between">
            <div class="text-xs font-bold tracking-widest uppercase opacity-70">Layout & Theme</div>
            <button onclick="toggleOptions()" class="text-xs opacity-60">Close</button>
        </div>
        <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest opacity-70">
            Layout
            <select id="layout-select" class="bg-white/5 border border-white/10 rounded-xl p-2 text-sm">
                <option value="classic">Classic</option>
                <option value="alt">Studio</option>
            </select>
        </label>
        <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest opacity-70">
            Theme
            <select id="theme-select" class="bg-white/5 border border-white/10 rounded-xl p-2 text-sm">
                <option value="classic">Classic Night</option>
                <option value="sunset">Sunset Glow</option>
                <option value="neon">Neon Pulse</option>
                <option value="glacier">Glacier Ice</option>
            </select>
        </label>
        <div class="text-[11px] opacity-60">Use the sun icon to jump to the bright day palette.</div>
    </div>

    <main id="view-player" class="flex-1 flex flex-col gap-6">
        <div class="flex-none min-h-[7rem] sm:h-auto sm:flex-1 glass-card lcd-display flex flex-col justify-between relative overflow-hidden">
            <div class="p-4 sm:p-8">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-[10px] font-bold tracking-widest text-emerald-500 uppercase" id="mode-indicator">Connected</div>
                </div>
                <div class="flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-baseline gap-2 sm:gap-6">
                    <h2 class="time-display time-display-glow text-4xl sm:text-6xl font-bold mb-2 truncate" id="display-title">00:00</h2>
                    <div id="sleep-timer-display" class="time-display time-display-glow text-4xl sm:text-6xl font-bold uppercase tracking-widest mb-2">Sleep: Off</div>
                </div>
            </div>
            
            <div class="w-full">
                <div class="flex justify-end px-4 sm:px-8 text-[11px] mb-2 font-semibold opacity-60">
                    <span id="duration" class="time-display">00:00</span>
                </div>
                <input type="range" id="seek-bar" class="seek-bar hidden sm:block" value="0" step="1">
            </div>
        </div>

        <div class="flex flex-col gap-6 px-2" id="control-stack">
            <div class="sm:hidden flex flex-col gap-3" id="progress-block">
                <span class="text-[10px] font-black opacity-30 tracking-tighter">PROGRESS</span>
                <input type="range" id="seek-bar-mobile" class="seek-bar" value="0" step="1">
            </div>

            <div class="hidden sm:flex items-center gap-6" id="volume-block">
                <span class="text-[10px] font-black opacity-30 tracking-tighter">VOL</span>
                <input type="range" id="vol-control" class="vol-control" min="0" max="1" step="0.05" value="1">
            </div>

            <div class="grid grid-cols-2 gap-3" id="sleep-block">
                <button onclick="setSleepTimer(15)" class="glass-card bg-white/5 py-3 text-xs font-semibold tracking-wide uppercase active:scale-95 transition-transform">Sleep in 15 mins</button>
                <button onclick="setSleepTimer(30)" class="glass-card bg-white/5 py-3 text-xs font-semibold tracking-wide uppercase active:scale-95 transition-transform">Sleep in 30 mins</button>
            </div>
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-3" id="preset-block">
                <button onpointerdown="handlePresetStart(1)" onpointerup="handlePresetEnd(1)" onpointercancel="handlePresetCancel()" onpointerleave="handlePresetCancel()" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-1"><span class="text-xl font-bold">1</span><span class="preset-label truncate w-full px-2" id="label-1"></span></button>
                <button onpointerdown="handlePresetStart(2)" onpointerup="handlePresetEnd(2)" onpointercancel="handlePresetCancel()" onpointerleave="handlePresetCancel()" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-2"><span class="text-xl font-bold">2</span><span class="preset-label truncate w-full px-2" id="label-2"></span></button>
                <button onpointerdown="handlePresetStart(3)" onpointerup="handlePresetEnd(3)" onpointercancel="handlePresetCancel()" onpointerleave="handlePresetCancel()" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-3"><span class="text-xl font-bold">3</span><span class="preset-label truncate w-full px-2" id="label-3"></span></button>
                <button onpointerdown="handlePresetStart(4)" onpointerup="handlePresetEnd(4)" onpointercancel="handlePresetCancel()" onpointerleave="handlePresetCancel()" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-4"><span class="text-xl font-bold">4</span><span class="preset-label truncate w-full px-2" id="label-4"></span></button>
                <button onpointerdown="handlePresetStart(5)" onpointerup="handlePresetEnd(5)" onpointercancel="handlePresetCancel()" onpointerleave="handlePresetCancel()" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-5"><span class="text-xl font-bold">5</span><span class="preset-label truncate w-full px-2" id="label-5"></span></button>
                <button onpointerdown="handlePresetStart(6)" onpointerup="handlePresetEnd(6)" onpointercancel="handlePresetCancel()" onpointerleave="handlePresetCancel()" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-6"><span class="text-xl font-bold">6</span><span class="preset-label truncate w-full px-2" id="label-6"></span></button>
            </div>

            <div class="flex gap-4 h-24 items-stretch" id="transport-block">
                <div class="flex flex-1 gap-4">
                    <button onclick="smartSeek(-15)" class="flex-1 glass-card bg-white/5 text-3xl active:scale-95 transition-transform">⏮</button>
                    <button onclick="togglePlay()" id="play-btn" class="w-1/3 glass-card bg-emerald-500 text-black text-4xl shadow-xl active:scale-95 transition-transform">▶</button>
                    <button onclick="smartSeek(30)" class="flex-1 glass-card bg-white/5 text-3xl active:scale-95 transition-transform">⏭</button>
                </div>
                <div class="sm:hidden flex flex-col items-center gap-2 w-10">
                    <span class="text-[10px] font-black opacity-30 tracking-tighter">VOL</span>
                    <input type="range" id="vol-control-mobile" class="vol-control vol-vertical" min="0" max="1" step="0.05" value="1">
                </div>
            </div>
        </div>
    </main>

    <div id="overlay-library" class="fixed inset-0 bg-[#0a0c10]/95 backdrop-blur-2xl z-50 p-6 hidden flex flex-col">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold tracking-tight">Media Explorer</h2>
            <div class="flex gap-3">
                <button id="mgr-toggle" onclick="toggleManager()" class="px-4 py-2 border border-emerald-500/30 rounded-xl text-[11px] font-bold uppercase">Manage Radio</button>
                <button onclick="toggleView('player')" class="px-4 py-2 bg-red-500/20 text-red-500 rounded-xl font-bold uppercase">Exit</button>
            </div>
        </div>
        <input type="text" id="lib-search" oninput="renderLibrary()" placeholder="Search library..." class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl mb-6 text-xl outline-none">
        <div id="library-content" class="flex-1 overflow-y-auto space-y-4 pr-2"></div>
        
        <div class="mt-4 p-4 glass-card bg-white/5">
            <button onclick="toggleRadioForm()" class="w-full text-xs opacity-50 mb-2 uppercase tracking-widest font-bold">Add Radio Station (+)</button>
            <div id="radio-form" class="hidden flex flex-col gap-2">
                <input type="text" id="radio-name" placeholder="Name" class="bg-black/50 border border-white/10 p-3 rounded text-emerald-400">
                <input type="text" id="radio-url" placeholder="URL" class="bg-black/50 border border-white/10 p-3 rounded text-emerald-400">
                <button onclick="addRadioStation()" class="bg-emerald-500 text-black font-bold p-4 rounded-xl active:scale-95 transition-transform">SAVE STATION</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

<script>
    const BOOKMARKS_ENDPOINT = './api/bookmarks';
    const LIBRARY_CACHE_KEY = 'carstereo.libraryCache.v1';
    const USER_ID = new URLSearchParams(window.location.search).get('user') || 'default_stereo';
    let state = { presets: {}, radioStations: [], books: {}, currentSource: null, playbackPositions: {}, longPressTimer: null, isHolding: false, isManagerMode: false };
    let pendingResumeTime = 0;
    let isDragging = false;
    let sleepTimerId = null;
    let sleepIntervalId = null;
    let sleepEndTime = null;
    const audio = document.getElementById('audio-player');
    const seekBars = Array.from(document.querySelectorAll('.seek-bar'));
    const volumeControls = Array.from(document.querySelectorAll('.vol-control'));
    const modeIndicator = document.getElementById('mode-indicator');
    const defaultModeText = modeIndicator.textContent;
    const sleepDisplay = document.getElementById('sleep-timer-display');
    const defaultSleepText = sleepDisplay.textContent;
    const timeDisplay = document.getElementById('display-title');
    const optionsPanel = document.getElementById('options-panel');
    const themeSelect = document.getElementById('theme-select');
    const layoutSelect = document.getElementById('layout-select');
    const THEME_KEY = 'carstereo.theme.v1';
    const LAYOUT_KEY = 'carstereo.layout.v1';
    function showModeMessage(message, timeout = 3000) {
        if (sleepEndTime) return;
        modeIndicator.textContent = message;
        setTimeout(() => {
            if (!sleepEndTime) {
                modeIndicator.textContent = defaultModeText;
            }
        }, timeout);
    }

    function loadCachedLibrary() {
        try {
            const cached = JSON.parse(localStorage.getItem(LIBRARY_CACHE_KEY));
            if (cached && cached.books) {
                state.books = cached.books;
                return cached;
            }
        } catch (e) {
            return null;
        }
        return null;
    }

    function saveCachedLibrary() {
        localStorage.setItem(LIBRARY_CACHE_KEY, JSON.stringify({
            books: state.books,
            cachedAt: new Date().toISOString()
        }));
    }

    // UI Sync for Play/Pause Button
    audio.addEventListener('play', () => { document.getElementById('play-btn').textContent = '||'; });
    audio.addEventListener('pause', () => { document.getElementById('play-btn').textContent = '▶'; });

    // Position Recovery
    audio.addEventListener('canplay', () => {
        if (pendingResumeTime > 0) {
            audio.currentTime = pendingResumeTime;
            pendingResumeTime = 0;
        }
    });

    // Seek Bar Logic
    seekBars.forEach((bar) => {
        bar.addEventListener('mousedown', () => isDragging = true);
        bar.addEventListener('touchstart', () => isDragging = true);
        bar.addEventListener('input', (e) => { 
            updateCurrentTimeDisplay(e.target.value);
        });
        bar.addEventListener('change', (e) => {
            audio.currentTime = e.target.value;
            isDragging = false;
            savePosition();
        });
    });

    volumeControls.forEach((control) => {
        control.addEventListener('input', (e) => {
            audio.volume = e.target.value;
            volumeControls.forEach((other) => {
                if (other !== e.target) other.value = e.target.value;
            });
        });
    });

    async function sync(method = 'GET', body = null) {
        try {
            const options = { method };
            if (body) { options.headers = { 'Content-Type': 'application/json' }; options.body = JSON.stringify(body); }
            const res = await fetch(`${BOOKMARKS_ENDPOINT}?user=${encodeURIComponent(USER_ID)}`, options);
            return res.ok ? await res.json() : null;
        } catch (e) { return null; }
    }

    function toggleView(v) {
        document.getElementById('overlay-library').classList.toggle('hidden', v !== 'library');
        if (v === 'library') renderLibrary();
    }

    function toggleOptions() {
        optionsPanel.classList.toggle('hidden');
    }

    function applyTheme(theme) {
        const value = theme || 'classic';
        document.body.dataset.theme = value;
        if (themeSelect) themeSelect.value = value;
        localStorage.setItem(THEME_KEY, value);
    }

    function applyLayout(layout) {
        const value = layout || 'classic';
        document.body.dataset.layout = value;
        if (layoutSelect) layoutSelect.value = value;
        localStorage.setItem(LAYOUT_KEY, value);
    }

    function toggleManager() { 
        state.isManagerMode = !state.isManagerMode; 
        document.getElementById('mgr-toggle').textContent = state.isManagerMode ? "DONE" : "MANAGE RADIO";
        renderLibrary(); 
    }

    function toggleRadioForm() { document.getElementById('radio-form').classList.toggle('hidden'); }

    function playBook(bookName, trackIdx) {
        const track = state.books[bookName][trackIdx];
        state.currentSource = { type: 'book', data: { bookName, trackIdx, url: track.url, name: track.name } };
        const trackKey = `server:${track.url}`;
        pendingResumeTime = state.playbackPositions[trackKey] || 0;
        audio.src = track.url;
        audio.play(); toggleView('player');
        updateActivePresetButtons();
    }

    function playRadio(station) {
        pendingResumeTime = 0;
        state.currentSource = { type: 'radio', data: station };
        audio.src = station.url;
        audio.play(); toggleView('player');
        updateActivePresetButtons();
    }

    function handlePresetStart(id) {
        state.isHolding = false;
        state.longPressTimer = setTimeout(() => {
            if (state.currentSource) {
                state.presets[id] = state.currentSource;
                sync('POST', state);
                const btn = document.getElementById(`btn-${id}`);
                btn.classList.add('bg-emerald-500', 'text-black');
                setTimeout(() => btn.classList.remove('bg-emerald-500', 'text-black'), 500);
                updatePresetLabels();
                state.isHolding = true;
            }
        }, 1000);
    }

    function handlePresetEnd(id) {
        clearTimeout(state.longPressTimer);
        if (!state.isHolding && state.presets[id]) {
            const p = state.presets[id];
            p.type === 'radio' ? playRadio(p.data) : playBook(p.data.bookName, p.data.trackIdx);
        }
    }

    function handlePresetCancel() {
        clearTimeout(state.longPressTimer);
    }

    function updatePresetLabels() {
        for (let i = 1; i <= 6; i++) {
            const label = document.getElementById(`label-${i}`);
            const p = state.presets[i];
            label.textContent = p ? (p.type === 'radio' ? p.data.name : (p.data.name || p.data.bookName)) : "";
        }
        updateActivePresetButtons();
    }

    function updateActivePresetButtons() {
        const activeUrl = state.currentSource?.data?.url;
        for (let i = 1; i <= 6; i++) {
            const btn = document.getElementById(`btn-${i}`);
            const preset = state.presets[i];
            const isActive = preset?.data?.url && activeUrl && preset.data.url === activeUrl;
            btn.classList.toggle('preset-active', Boolean(isActive));
        }
    }

    function renderLibrary() {
        const query = document.getElementById('lib-search').value.toLowerCase();
        const container = document.getElementById('library-content');
        container.innerHTML = '';
        
        (Array.isArray(state.radioStations) ? state.radioStations : []).filter(s => (s?.name || '').toLowerCase().includes(query)).forEach((s, idx) => {
            if (!s) return;
            container.appendChild(createLibEntry(s.name || 'Unnamed Station', () => playRadio(s), 'radio', s, idx));
        });
        
        Object.keys(state.books || {}).forEach(bookName => {
            const tracks = Array.isArray(state.books[bookName]) ? state.books[bookName] : [];
            tracks.filter(t => (t?.name || '').toLowerCase().includes(query) || bookName.toLowerCase().includes(query)).forEach((t, i) => {
                if (!t) return;
                const bookData = { bookName, trackIdx: i, url: t.url, name: t.name };
                const label = (bookName === t.name) ? t.name : `${bookName} - ${t.name}`;
                container.appendChild(createLibEntry(label, () => playBook(bookName, i), 'book', bookData));
            });
        });
    }

    function createLibEntry(label, tuneFn, type, data, idx = null) {
        const entryData = data || {};
        const div = document.createElement('div');
        div.className = "glass-card p-6 flex flex-col gap-4";
        
        let tools = (state.isManagerMode && type === 'radio' && Number.isInteger(idx)) ? `
            <div class="flex gap-2 pt-2 border-t border-white/5">
                <button id="edit-${idx}" class="flex-1 bg-blue-500/10 text-blue-400 py-3 rounded-xl text-[10px] font-bold">RENAME</button>
                <button id="del-${idx}" class="flex-1 bg-red-500/10 text-red-400 py-3 rounded-xl text-[10px] font-bold">DELETE</button>
            </div>` : '';

        const pButtons = [1,2,3,4,5,6].map(p => {
            const preset = state.presets[p];
            const isActive = preset && preset.data && preset.data.url === entryData.url;
            return `<button data-assign="${p}" class="w-10 h-10 rounded-lg text-[10px] font-black transition-all ${isActive ? 'lib-p-active' : 'bg-white/5'}">P${p}</button>`;
        }).join('');
        
        div.innerHTML = `
            <div class="font-bold truncate text-lg tracking-tight">${label}</div>
            <div class="flex items-center gap-3">
                <button id="tune-btn" class="flex-1 bg-emerald-500 text-black py-3 rounded-xl font-bold text-xs active:scale-95 transition-transform">TUNE</button>
                <div class="flex gap-1">${pButtons}</div>
            </div>${tools}`;
        
        div.querySelector('#tune-btn').onclick = tuneFn;
        div.querySelectorAll('button[data-assign]').forEach(b => {
            const pNum = b.getAttribute('data-assign');
            b.onclick = () => {
                const existing = state.presets[pNum];
                if (existing && existing.data && existing.data.url === entryData.url) { delete state.presets[pNum]; } 
                else { state.presets[pNum] = { type, data: entryData }; }
                sync('POST', state); updatePresetLabels(); renderLibrary();
            };
        });

        if (state.isManagerMode && type === 'radio' && Number.isInteger(idx)) {
            const editBtn = div.querySelector(`#edit-${idx}`);
            const delBtn = div.querySelector(`#del-${idx}`);
            if (editBtn) editBtn.onclick = () => editRadio(idx);
            if (delBtn) delBtn.onclick = () => deleteRadio(idx);
        }
        return div;
    }

    function editRadio(idx) {
        const s = state.radioStations[idx];
        const n = prompt("New Name:", s.name);
        const u = prompt("New URL:", s.url);
        if (n && u) { state.radioStations[idx] = {name:n, url:u}; sync('POST', state); renderLibrary(); }
    }

    function deleteRadio(idx) {
        if(confirm("Delete station?")) { state.radioStations.splice(idx, 1); sync('POST', state); renderLibrary(); }
    }

    function addRadioStation() {
        const n = document.getElementById('radio-name').value;
        const u = document.getElementById('radio-url').value;
        if (n && u) { state.radioStations.push({ name: n, url: u }); sync('POST', state); renderLibrary(); toggleRadioForm(); }
    }

    function savePosition() {
        if (state.currentSource?.type === 'book' && audio.currentTime > 1) {
            state.playbackPositions[`server:${state.currentSource.data.url}`] = audio.currentTime;
            sync('POST', state);
        }
    }

    audio.ontimeupdate = () => {
        if (!isDragging) {
            seekBars.forEach((bar) => {
                bar.value = audio.currentTime;
                bar.max = audio.duration || 0;
            });
            updateCurrentTimeDisplay(audio.currentTime);
            document.getElementById('duration').textContent = formatTime(audio.duration);
            if (state.currentSource?.type === 'book' && Math.floor(audio.currentTime) % 10 === 0) savePosition();
        }
    };

    function updateCurrentTimeDisplay(value) {
        const timeText = formatTime(value);
        if (timeDisplay) timeDisplay.textContent = timeText;
    }

    function formatTime(s) { if(isNaN(s)) return "00:00"; const m=Math.floor(s/60); const sec=Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }
    function togglePlay() { audio.paused ? audio.play() : audio.pause(); }
    function toggleDayMode() { document.body.classList.toggle('day-mode'); }
    function smartSeek(s) { if (!audio.src || isNaN(audio.duration)) return; audio.currentTime = Math.max(0, Math.min(audio.currentTime + s, audio.duration)); savePosition(); }

    function updateSleepIndicator() {
        if (!sleepEndTime) return;
        const remainingMs = Math.max(0, sleepEndTime - Date.now());
        const remainingSeconds = Math.floor(remainingMs / 1000);
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        const remainingLabel = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        sleepDisplay.textContent = `Sleep: ${remainingLabel}`;
        if (remainingMs === 0) endSleepTimer();
    }

    function endSleepTimer() {
        if (sleepTimerId) clearTimeout(sleepTimerId);
        if (sleepIntervalId) clearInterval(sleepIntervalId);
        sleepTimerId = null;
        sleepIntervalId = null;
        sleepEndTime = null;
        audio.pause();
        sleepDisplay.textContent = 'Sleep: Ended';
        setTimeout(() => {
            if (!sleepEndTime) {
                sleepDisplay.textContent = defaultSleepText;
            }
        }, 3000);
    }

    function setSleepTimer(minutes) {
        if (sleepTimerId) clearTimeout(sleepTimerId);
        if (sleepIntervalId) clearInterval(sleepIntervalId);
        sleepEndTime = Date.now() + minutes * 60 * 1000;
        updateSleepIndicator();
        sleepIntervalId = setInterval(updateSleepIndicator, 1000);
        sleepTimerId = setTimeout(endSleepTimer, minutes * 60 * 1000);
    }

    async function init() {
        const savedTheme = localStorage.getItem(THEME_KEY) || 'classic';
        const savedLayout = localStorage.getItem(LAYOUT_KEY) || 'classic';
        applyTheme(savedTheme);
        applyLayout(savedLayout);
        if (themeSelect) themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
        if (layoutSelect) layoutSelect.addEventListener('change', (e) => applyLayout(e.target.value));
        const data = await sync('GET');
        if (data) { Object.assign(state, data); }
        const cachedLibrary = loadCachedLibrary();
        let libraryFetched = false;
        try {
            const res = await fetch('./books/');
            if (res.ok) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(await res.text(), 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                    .map(a => a.getAttribute('href'))
                    .filter(h => h && !h.startsWith('?') && !h.startsWith('/'));
                const latestBooks = {};
                for (const link of links) {
                    if (link.endsWith('/')) {
                        const bookName = decodeURIComponent(link.replace(/\/$/, ''));
                        const folderRes = await fetch(`./books/${link}`);
                        if (!folderRes.ok) continue;
                        const folderDoc = parser.parseFromString(await folderRes.text(), 'text/html');
                        const tracks = Array.from(folderDoc.querySelectorAll('a'))
                            .map(a => a.getAttribute('href'))
                            .filter(h => h && h.toLowerCase().endsWith('.mp3'))
                            .map(h => ({ name: decodeURIComponent(h), url: `./books/${link}${h}` }));
                        if (tracks.length > 0) latestBooks[bookName] = tracks;
                    } else if (link.toLowerCase().endsWith('.mp3')) {
                        const fn = decodeURIComponent(link);
                        latestBooks[fn] = [{ name: fn, url: `./books/${link}` }];
                    }
                }
                state.books = latestBooks;
                saveCachedLibrary();
                libraryFetched = true;
                showModeMessage('LIBRARY SYNCED');
            }
        } catch (e) {
            libraryFetched = false;
        }
        if (!libraryFetched) {
            if (cachedLibrary) {
                showModeMessage('OFFLINE CACHE');
            } else {
                showModeMessage('OFFLINE MODE');
            }
        }
        updatePresetLabels();
    }
    init();
</script>
</body>
</html>
