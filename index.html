<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarStereo Infotainment v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0a0c10; --text: #e2e8f0; --accent: #10b981; 
            --panel: rgba(30, 41, 59, 0.5); --glass: rgba(255, 255, 255, 0.03);
        }
        .day-mode { 
            --bg: #f8fafc; --text: #1e293b; --accent: #059669; 
            --panel: rgba(226, 232, 240, 0.8); --glass: rgba(0, 0, 0, 0.05);
        }
        body { 
            background: radial-gradient(circle at top right, #1e293b, var(--bg)); 
            color: var(--text); font-family: 'Inter', sans-serif; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .glass-card { 
            background: var(--panel); backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; 
        }
        .lcd-display { background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(0,0,0,0) 100%); }
        .preset-btn { 
            background: var(--glass); border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease; border-radius: 1.25rem;
        }
        .lib-p-active { background: var(--accent) !important; color: white !important; box-shadow: 0 0 15px var(--accent); }
        .preset-label { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; }
        
        /* Full Width Seek Bar Styling */
        input[type=range] { width: 100%; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.1); appearance: none; outline: none; }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 20px; height: 20px; 
            background: var(--accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 15px var(--accent);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden p-4 sm:p-6">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight">INFOTAINMENT <span class="text-emerald-500 font-light">3.1</span></h1>
            <p class="text-[10px] uppercase tracking-[0.3em] opacity-40">Connected Audio System</p>
        </div>
        <div class="flex gap-3">
            <button onclick="toggleDayMode()" class="p-3 rounded-full bg-white/5 border border-white/10">☀️</button>
            <button onclick="toggleView('library')" class="px-6 py-2 rounded-2xl font-bold bg-emerald-500 text-black transition-transform active:scale-95">LIBRARY</button>
        </div>
    </header>

    <main id="view-player" class="flex-1 flex flex-col gap-6">
        <div class="flex-1 glass-card lcd-display flex flex-col justify-between relative overflow-hidden">
            <div class="p-8">
                <div class="mb-2 text-[10px] font-bold tracking-widest text-emerald-500 uppercase" id="mode-indicator">Streaming Active</div>
                <h2 class="text-4xl sm:text-5xl font-bold mb-2 tracking-tight truncate" id="display-title">Ready</h2>
                <p class="text-lg opacity-40 font-light truncate" id="display-subtitle">Select source</p>
            </div>
            
            <div class="w-full px-0">
                <div class="flex justify-between px-8 text-[11px] mb-2 font-semibold opacity-60">
                    <span id="current-time">00:00</span>
                    <span id="duration">00:00</span>
                </div>
                <input type="range" id="seek-bar" value="0" step="1" class="rounded-none">
            </div>
        </div>

        <div class="flex flex-col gap-6 px-2">
            <div class="flex items-center gap-6">
                <span class="text-[10px] font-black opacity-30 tracking-tighter">VOL</span>
                <input type="range" id="vol-control" min="0" max="1" step="0.05" value="1">
            </div>

            <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                ${[1,2,3,4,5,6].map(i => `
                <button onmousedown="handlePresetStart(${i})" onmouseup="handlePresetEnd(${i})" class="preset-btn h-20 flex flex-col items-center justify-center gap-1" id="btn-${i}">
                    <span class="text-xl font-bold">${i}</span>
                    <span class="preset-label truncate w-full px-2" id="label-${i}"></span>
                </button>`).join('')}
            </div>

            <div class="flex gap-4 h-24">
                <button onclick="smartSeek(-15)" class="flex-1 glass-card bg-white/5 text-3xl active:scale-95 transition-transform">⏮</button>
                <button onclick="togglePlay()" id="play-btn" class="w-1/3 glass-card bg-emerald-500 text-black text-4xl shadow-xl shadow-emerald-500/20 active:scale-95 transition-transform">▶</button>
                <button onclick="smartSeek(30)" class="flex-1 glass-card bg-white/5 text-3xl active:scale-95 transition-transform">⏭</button>
            </div>
        </div>
    </main>

    <div id="overlay-library" class="fixed inset-0 bg-[#0a0c10]/95 backdrop-blur-2xl z-50 p-6 hidden flex flex-col">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold tracking-tight">Media Explorer</h2>
            <button onclick="toggleView('player')" class="px-4 py-2 bg-red-500/20 text-red-500 rounded-xl font-bold">EXIT</button>
        </div>
        <input type="text" id="lib-search" oninput="renderLibrary()" placeholder="Search library..." class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl mb-6 text-xl outline-none">
        <div id="library-content" class="flex-1 overflow-y-auto space-y-4 pr-2"></div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

<script>
    const BOOKMARKS_ENDPOINT = './api/bookmarks';
    const USER_ID = new URLSearchParams(window.location.search).get('user') || 'default_stereo';
    let state = { presets: {}, radioStations: [], books: {}, currentSource: null, playbackPositions: {}, longPressTimer: null, isHolding: false };
    const audio = document.getElementById('audio-player');

    // --- SMART SEEK LOGIC ---
    function smartSeek(seconds) {
        if (!audio.src || isNaN(audio.duration)) return;
        
        // If rewinding near the start, go to previous track
        if (seconds < 0 && audio.currentTime < 5) {
            prevTrack();
            return;
        }

        const newTime = audio.currentTime + seconds;
        audio.currentTime = Math.max(0, Math.min(newTime, audio.duration));
        
        const direction = seconds > 0 ? "FFWD" : "RWD";
        console.log(`${direction}: ${Math.abs(seconds)}s`);
    }

    function prevTrack() {
        if (state.currentSource?.type === 'book') {
            const { bookName, trackIdx } = state.currentSource.data;
            if (trackIdx > 0) playBook(bookName, trackIdx - 1);
        }
    }

    function nextTrack() {
        if (state.currentSource?.type === 'book') {
            const { bookName, trackIdx } = state.currentSource.data;
            if (state.books[bookName] && trackIdx < state.books[bookName].length - 1) {
                playBook(bookName, trackIdx + 1);
            }
        }
    }

    // --- CORE LOGIC (V3.0 baseline with V3.1 label fix) ---
    function updatePresetLabels() {
        for (let i = 1; i <= 6; i++) {
            const label = document.getElementById(`label-${i}`);
            const p = state.presets[i];
            if (p) {
                label.textContent = p.type === 'radio' ? p.data.name : (p.data.name || p.data.bookName);
            } else {
                label.textContent = "";
            }
        }
    }

    function playBook(bookName, trackIdx) {
        const track = state.books[bookName][trackIdx];
        state.currentSource = { type: 'book', data: { bookName, trackIdx, url: track.url, name: track.name } };
        audio.src = track.url;
        document.getElementById('display-title').textContent = track.name.toUpperCase();
        document.getElementById('display-subtitle').textContent = (bookName === track.name) ? "SINGLE FILE" : bookName.toUpperCase();
        document.getElementById('playback-info').style.opacity = "1";
        const trackKey = `server:${track.url}`;
        if (state.playbackPositions[trackKey]) audio.currentTime = state.playbackPositions[trackKey];
        audio.play(); toggleView('player');
    }

    function playRadio(station) {
        state.currentSource = { type: 'radio', data: station };
        audio.src = station.url;
        document.getElementById('display-title').textContent = station.name.toUpperCase();
        document.getElementById('display-subtitle').textContent = "LIVE RADIO";
        document.getElementById('playback-info').style.opacity = "0.2";
        audio.play(); toggleView('player');
    }

    // Standard Handlers
    function togglePlay() { audio.paused ? audio.play() : audio.pause(); }
    function toggleDayMode() { document.body.classList.toggle('day-mode'); }
    function toggleView(v) { document.getElementById('overlay-library').classList.toggle('hidden', v !== 'library'); }
    
    // Server Sync
    async function sync(method = 'GET', body = null) {
        try {
            const options = { method };
            if (body) { options.headers = { 'Content-Type': 'application/json' }; options.body = JSON.stringify(body); }
            const res = await fetch(`${BOOKMARKS_ENDPOINT}?user=${encodeURIComponent(USER_ID)}`, options);
            return res.ok ? await res.json() : null;
        } catch (e) { return null; }
    }

    audio.ontimeupdate = () => {
        const bar = document.getElementById('seek-bar');
        bar.value = audio.currentTime; bar.max = audio.duration || 0;
        document.getElementById('current-time').textContent = formatTime(audio.currentTime);
        document.getElementById('duration').textContent = formatTime(audio.duration);
        if (state.currentSource?.type === 'book' && Math.floor(audio.currentTime) % 15 === 0) {
            state.playbackPositions[`server:${state.currentSource.data.url}`] = audio.currentTime;
            sync('POST', state);
        }
    };

    function formatTime(s) { if(isNaN(s)) return "00:00"; const m=Math.floor(s/60); const sec=Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }
    document.getElementById('vol-control').oninput = (e) => audio.volume = e.target.value;
    document.getElementById('seek-bar').oninput = (e) => audio.currentTime = e.target.value;

    // Initialize
    async function init() {
        const data = await sync('GET');
        if (data) { Object.assign(state, data); }
        // Fetch books folder logic from v2.8/v3.0 remains same
        const res = await fetch('./books/');
        if (res.ok) {
            const text = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const links = Array.from(doc.querySelectorAll('a')).map(a => a.getAttribute('href')).filter(h => h && !h.startsWith('?') && !h.startsWith('/'));
            for (const link of links) {
                if (link.endsWith('/')) {
                    const bookName = decodeURIComponent(link.replace(/\/$/, ''));
                    const trackRes = await fetch(`./books/${link}`);
                    const tracks = Array.from(parser.parseFromString(await trackRes.text(), 'text/html').querySelectorAll('a'))
                        .map(a => a.getAttribute('href')).filter(h => h.toLowerCase().endsWith('.mp3'))
                        .map(h => ({ name: decodeURIComponent(h), url: `./books/${link}${h}` }));
                    if (tracks.length > 0) state.books[bookName] = tracks;
                } else if (link.toLowerCase().endsWith('.mp3')) {
                    const fileName = decodeURIComponent(link);
                    state.books[fileName] = [{ name: fileName, url: `./books/${link}` }];
                }
            }
        }
        updatePresetLabels();
    }
    init();
</script>
</body>
</html>
